---
title: 多线程基础
date: 2018-06-24 23:47:00
tags: [多线程]
categories: iOS
---

# 多线程的概念

不管我们是做客户端还是服务端，理解多线程更有利于我们的开发。简单了解一下基本概念

* 进程：可以当做一个程序的实体，每个进程至少有一条线程
* 线程：不知道怎么解释，比较抽象，相当于进程的一个通道吧！，每个进程至少会拥有一条线程，Mac电脑可以通过活动监视器来看
 * 线程同步：多条线程在同一条线上执行，**可理解为进程或线程A和B一块配合，A执行到一定程度时要依靠B的某个结果，于是停下来，让B运行；B执行之后结果给A；A再继续操作**
 * 串行：一个任务执行完再执行下一个任务
<!----more--->

# 多线程原理
多线程只是充分的利用CPU的性能，**同一时间内，CPU只能处理一条线程，多条线程并发执行，只是CPU快速在多条线程之间调度**

# 多线程的状态
![](/images/线程状态.png)

# 多线程安全问题
多个线程同时访问同一个块内存，容易出现数据不准确的问题<可以参考经典的买票问题>

## 如何解决这个问题
  使用互斥锁。互斥锁指的是**一段代码段在同一个时间只能允许被一个线程访问，例如线程A进入加锁代码之后，线程B就无法访问，只有线程A执行完加锁代码后解锁，B线程才能访问加锁代码**
  
## 使用互斥锁的注意事项

多个线程需要使用同一个把锁，使用多个锁是无效的

## 互斥锁的优缺点
优点：能解决多个线程抢夺同一资源时造成的安全问题
缺点：需要消耗大量的CPU资源

## iOS中的属性
nonatomic：非原子属性，不会对setter方法加锁
atomic: 原子属性，会对setter方法进行加锁


# GCD
GCD是苹果公司为多核的并发运算提出的解决方案，会自动管理线程的生命周期（创建，调度，销毁）[点击查看源码](http://libdispatch.macosforge.org)

## GCD的基本概念
 * 同步：在当前线程操作，不具备开线程的能力
 * 异步：可以开辟新的线程
 * 任务：用来执行什么操作
 * 队列：用来存放任务
    *  并发队列： 可以让多个任务并发执行的，只有在异步线程中有效
    *  串行队列：一个任务执行完，再执行下一个任务


调用步骤：创建队列 -> 制定任务 -> 将任务添加到队列
队列原则：先进先出

## 队列

 * 系统标准队列
  
 ```
//全局队列，一个并行的队列
dispatch_get_global_queue
//主队列，主线程中的唯一队列，一个串行队列
dispatch_get_main_queue
 ```
   
   * 自定义队列

 ```
//串行队列
dispatch_queue_create("com.starming.serialqueue", DISPATCH_QUEUE_SERIAL)
//并行队列
dispatch_queue_create("com.starming.concurrentqueue", DISPATCH_QUEUE_CONCURRENT)
 ```
 
* 使用队列的注意事项 
串行队列，不能在任务中再添加同一串行队列的任务，会造成死循环,例如：

 ```
会造成死循环的代码
 创建串行队列
dispatch_queue_t queue = dispatch_queue_create("one", DISPATCH_QUEUE_SERIAL);
dispatch_sync(queue, ^{
        NSLog(@"%@ --",[NSThread currentThread]);
        dispatch_sync(queue, ^{
            NSLog(@"%@ --",[NSThread currentThread]);
        });
    });
```

## 创建线程

```
dispatch_async(dispatch_queue_t  _Nonnull queue, ^(void)block)
dispatch_sync(dispatch_queue_t  _Nonnull queue, ^(void)block)
``` 






